# CVLab-Kit Docker Compose
#
# Directory structure (on host):
#   /volume1/docker/cvlab-kit/
#   â”œâ”€â”€ compose.yml          # This file (copy from repo, persistent)
#   â”œâ”€â”€ data/                 # Persistent data (NEVER delete)
#   â”‚   â”œâ”€â”€ logs/             # Run logs
#   â”‚   â”œâ”€â”€ queue_logs/       # Experiment logs
#   â”‚   â””â”€â”€ state/            # DB and JSON state files (auto-created)
#   â””â”€â”€ src/                 # Source code (can delete & re-clone)
#
# First time setup:
#   mkdir -p /volume1/docker/cvlab-kit/{data/logs,data/queue_logs,data/state,src}
#   # Copy this compose.yml to /volume1/docker/cvlab-kit/
#   docker compose up -d
#
# Update code:
#   docker compose restart
#
# Force re-clone (if git broken):
#   rm -rf /volume1/docker/cvlab-kit/src/*
#   docker compose restart

services:
  cvlab-kit:
    image: python:3.10-slim
    container_name: cvlab-kit
    ports:
      - "8000:8000"
    volumes:
      # Source code (disposable)
      - /volume1/docker/cvlab-kit/src:/app
      # Persistent data (mounted over source paths)
      - /volume1/docker/cvlab-kit/data/logs:/app/logs
      - /volume1/docker/cvlab-kit/data/queue_logs:/app/web_helper/queue_logs
      - /volume1/docker/cvlab-kit/data/state:/app/web_helper/state
    working_dir: /app
    command:
      - bash
      - -c
      - |
        set -e

        echo 'ðŸ”§ Installing system dependencies...'
        apt-get update -qq && apt-get install -y -qq git curl build-essential >/dev/null
        if ! command -v node > /dev/null; then
          echo 'ðŸ“¦ Installing Node.js...'
          curl -fsSL https://deb.nodesource.com/setup_18.x | bash - >/dev/null
          apt-get install -y -qq nodejs >/dev/null
        fi
        pip install -q uv

        clone_and_setup() {
          echo 'ðŸ“¥ Cloning repository...'
          rm -rf /tmp/cvlab-clone
          git clone --depth 1 https://github.com/deveronica/cvlab-kit.git /tmp/cvlab-clone

          echo 'ðŸ“ Copying source (preserving mounted volumes)...'
          cd /tmp/cvlab-clone
          for item in $(ls -A | grep -v -E '^(logs|web_helper)$'); do
            cp -a "$item" /app/
          done
          cp -a web_helper/* /app/web_helper/ 2>/dev/null || true
          rm -rf /tmp/cvlab-clone
          cd /app

          echo 'ðŸ“¦ Installing Python dependencies...'
          uv sync --frozen

          echo 'ðŸŽ¨ Building frontend...'
          cd web_helper/frontend && npm ci --silent && npm run build && cd ../..
        }

        if [ ! -f /app/pyproject.toml ]; then
          echo 'ðŸ†• First time setup...'
          clone_and_setup
        else
          echo 'ðŸ”„ Updating code...'
          cd /app
          OLD_HEAD=$(git rev-parse HEAD)
          git fetch origin main
          git reset --hard origin/main
          NEW_HEAD=$(git rev-parse HEAD)

          echo 'ðŸ“¦ Syncing dependencies...'
          uv sync --frozen

          if [ "$OLD_HEAD" != "$NEW_HEAD" ] && git diff --name-only $OLD_HEAD $NEW_HEAD | grep -q 'web_helper/frontend'; then
            echo 'ðŸŽ¨ Frontend changed, rebuilding...'
            cd web_helper/frontend && npm run build && cd ../..
          fi
        fi

        echo 'âœ… Ready!'
        exec uv run app.py --server-only
    restart: unless-stopped
