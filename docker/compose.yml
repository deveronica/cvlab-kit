services:
  cvlab-kit:
    image: python:3.10-slim
    container_name: cvlab-kit
    ports:
      - "8000:8000"
    volumes:
      # Host paths (Docker auto-creates if missing)
      - /volume1/docker/cvlab-kit:/app
    working_dir: /app
    environment:
      - GIT_REPO=https://github.com/deveronica/cvlab-kit.git
    command: >
      bash -c "
      echo 'ğŸ”§ Installing dependencies...';
      apt-get update -qq && apt-get install -y -qq git curl build-essential;
      if ! command -v node > /dev/null; then
        echo 'ğŸ“¦ Installing Node.js...';
        curl -fsSL https://deb.nodesource.com/setup_18.x | bash -;
        apt-get install -y -qq nodejs;
      fi;
      pip install uv;

      if [ ! -d .git ]; then
        echo 'ğŸ“¥ Initial setup: Cloning repository...';

        # Clone to temp dir, then copy to /app
        git clone $$GIT_REPO /tmp/cvlab-clone || { echo 'âŒ Git clone failed!'; exit 1; };
        cp -a /tmp/cvlab-clone/. /app/ || { echo 'âŒ File copy failed!'; exit 1; };
        rm -rf /tmp/cvlab-clone;

        mkdir -p logs outputs config web_helper/state web_helper/queue_logs;
        if command -v nvidia-smi > /dev/null; then
          echo 'ğŸ® NVIDIA GPU detected, installing GPU support...';
          uv sync --frozen --extra gpu || { echo 'âŒ uv sync failed!'; exit 1; };
        else
          uv sync --frozen || { echo 'âŒ uv sync failed!'; exit 1; };
        fi;
        cd web_helper/frontend && npm ci && npm run build && cd ../.. || { echo 'âŒ Frontend build failed!'; exit 1; };
        echo 'âœ… Setup complete!';
      else
        echo 'ğŸ”„ Updating from git...';
        mkdir -p logs outputs config web_helper/state web_helper/queue_logs;
        git pull;
        if command -v nvidia-smi > /dev/null; then
          echo 'ğŸ® NVIDIA GPU detected, installing GPU support...';
          uv sync --frozen --extra gpu;
        else
          uv sync --frozen;
        fi;
        if git diff --name-only HEAD@{1} HEAD 2>/dev/null | grep -q 'web_helper/frontend/src'; then
          echo 'ğŸ¨ Frontend changed, rebuilding...';
          cd web_helper/frontend && npm run build && cd ../..;
        fi;
      fi;

      echo 'ğŸš€ Starting server (server-only mode)...';
      exec uv run app.py --server-only
      "
    restart: unless-stopped
