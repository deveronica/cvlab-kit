version: '3.8'

# Synology Container Manager Deployment Configuration
#
# Prerequisites:
# 1. Create folder structure in File Station:
#    /docker/cvlab-kit/logs
#    /docker/cvlab-kit/outputs
#    /docker/cvlab-kit/config
#    /docker/cvlab-kit/state
#    /docker/cvlab-kit/queue_logs
#
# 2. Upload entire cvlab-kit repository to:
#    /docker/cvlab-kit/source/
#
# 3. In Container Manager:
#    - Project â†’ Create
#    - Upload this file
#    - Set environment variables below
#    - Build & Run

services:
  cvlab-kit:
    build:
      context: /volume1/docker/cvlab-kit/source
      dockerfile: docker/Dockerfile
    container_name: cvlab-kit

    ports:
      - "8000:8000"    # Web UI & API

    volumes:
      # Persistent data (survives container restarts)
      - /volume1/docker/cvlab-kit/logs:/app/logs
      - /volume1/docker/cvlab-kit/outputs:/app/outputs
      - /volume1/docker/cvlab-kit/config:/app/config
      - /volume1/docker/cvlab-kit/state:/app/web_helper/state
      - /volume1/docker/cvlab-kit/queue_logs:/app/web_helper/queue_logs

    environment:
      # Required: Set your values here (Synology doesn't support .env files)
      - WANDB_API_KEY=                    # Optional: Get from https://wandb.ai/authorize
      - PYTHONUNBUFFERED=1

      # Server-only mode (GPU workers run on external machines)
      # Leave empty to run with local worker (CPU only)
      - SERVER_MODE=true

    # Server-only mode: no GPU required
    # GPU workers run on external workstations
    command: uv run app.py --server-only

    restart: unless-stopped

    # Health check
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
